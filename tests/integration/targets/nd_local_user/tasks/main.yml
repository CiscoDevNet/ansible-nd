# Test code for the ND modules
# Copyright: (c) 2025, Gaspard Micol (@gmicol) <gmicol@cisco.com>

# GNU General Public License v3.0+ (see LICENSE or https://www.gnu.org/licenses/gpl-3.0.txt)

- name: Test that we have a Nexus Dashboard host, username and password
  ansible.builtin.fail:
    msg: 'Please define the following variables: ansible_host, ansible_user and ansible_password.'
  when: ansible_host is not defined or ansible_user is not defined or ansible_password is not defined

- name: Set vars
  ansible.builtin.set_fact:
    nd_info: &nd_info
      output_level: '{{ api_key_output_level | default("debug") }}'

- name: Ensure local users do not exist before test starts
  cisco.nd.nd_local_user:
    <<: *nd_info
    config:
      - login_id: ansible_local_user
      - login_id: ansible_local_user_2
    state: deleted

# CREATE
- name: Create local users with full and minimum configuration (check mode)
  cisco.nd.nd_local_user: &create_local_user
    <<: *nd_info
    config:
      - email: ansibleuser@example.com
        login_id: ansible_local_user
        first_name: Ansible first name
        last_name: Ansible last name
        user_password: ansibleLocalUserPassword1%Test
        reuse_limitation: 20
        time_interval_limitation: 10
        security_domains:
          - name: all
            roles:
              - observer
              - support_engineer
        remote_id_claim: ansible_remote_user
        remote_user_authorization: true
      - login_id: ansible_local_user_2
        user_password: ansibleLocalUser2Password1%Test
        security_domains:
          - name: all
    state: merged
  check_mode: true
  register: cm_create_local_user

- name: Create local users with full and minimum configuration (normal mode)
  cisco.nd.nd_local_user:
    <<: *create_local_user
  register: nm_create_local_user

# UPDATE
- name: Update all ansible_local_user's attributes (check mode)
  cisco.nd.nd_local_user: &update_first_local_user
    <<: *nd_info
    config:
      - email: updatedansibleuser@example.com
        login_id: ansible_local_user
        first_name: Updated Ansible first name
        last_name: Updated Ansible last name
        user_password: updatedAnsibleLocalUserPassword1%
        reuse_limitation: 25
        time_interval_limitation: 15
        security_domains:
          - name: all
            roles: super_admin
        remote_id_claim: ""
        remote_user_authorization: false
    state: replaced
  check_mode: true
  register: cm_update_local_user

- name: Update local user (normal mode)
  cisco.nd.nd_local_user:
    <<: *update_first_local_user
  register: nm_update_local_user

- name: Update all ansible_local_user_2's attributes except password
  cisco.nd.nd_local_user: &update_second_local_user
    <<: *nd_info
    config:
      - email: secondansibleuser@example.com
        login_id: ansible_local_user_2
        first_name: Second Ansible first name
        last_name: Second Ansible last name
        reuse_limitation: 20
        time_interval_limitation: 10
        security_domains:
          - name: all
            roles: fabric_admin
        remote_id_claim: ansible_remote_user_2
        remote_user_authorization: true
    state: merged
  register: nm_update_local_user_2

- name: Update all ansible_local_user_2's attributes except password again (idempotency)
  cisco.nd.nd_local_user:
    <<: *update_second_local_user
  register: nm_update_local_user_2_again


# DELETE
- name: Delete local user by name (check mode)
  cisco.nd.nd_local_user: &delete_local_user
    <<: *nd_info
    config:
      - login_id: ansible_local_user
    state: deleted
  check_mode: true
  register: cm_delete_local_user

- name: Delete local user by name (normal mode)
  cisco.nd.nd_local_user:
    <<: *delete_local_user
  register: nm_delete_local_user

- name: Delete local user again (idempotency test)
  cisco.nd.nd_local_user:
    <<: *delete_local_user
  register: nm_delete_local_user_again


# CLEAN UP
- name: Ensure local users do not exist
  cisco.nd.nd_local_user:
    <<: *nd_info
    config:
      - login_id: ansible_local_user
      - login_id: ansible_local_user_2
    state: deleted
