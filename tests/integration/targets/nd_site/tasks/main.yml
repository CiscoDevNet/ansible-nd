# Test code for the ND modules
# Copyright: (c) 2023, Anvitha Jain (@anvitha-jain) <anvjain@cisco.com>

# GNU General Public License v3.0+ (see LICENSE or https://www.gnu.org/licenses/gpl-3.0.txt)

# - name: Test that we have an Nexus Dashboard Insights Group and Site Name defined
#   fail:
#     msg: "Please define the following variables: insights_group, site_name."
#   when: insights_group is not defined or site_name is not defined

- name: Set vars
  set_fact:
    aci_info: &aci_info
      output_level: '{{ site_output_level | default("debug") }}'


# DELETE SITEs
- name: Delete site (check mode)
  cisco.nd.nd_site: &delete_site
    <<: *aci_info
    name: "{{ item }}"
    state: absent
  check_mode: true
  register: remove_site_cm
  loop:
  - aci_site
  - cloud_test
  - fabric-standalone
  - edge

- name: Delete site (normal mode)
  cisco.nd.nd_site:
    <<: *aci_info
    name: aci_site
    state: absent
  register: remove_site

- name: Delete site again
  cisco.nd.nd_site:
    <<: *delete_site
  register: remove_site_again

- name: Verify remove_site_again
  assert:
    that:
    - remove_site_again is not changed

# QUERY SITEs
- name: Query All Sites
  cisco.nd.nd_site:
    <<: *aci_info
    state: query
  register: query_all_sites

- name: Query one Sites
  cisco.nd.nd_site:
    <<: *aci_info
    name: '{{ mso_site | default("ansible_test") }}'
    state: query
  register: query_site


# ADD SITE
- name: Add site (check mode)
  cisco.nd.nd_site: &site_present
    <<: *aci_info
    url: {{ apic_ip_address }}
    site_username: '{{ site_username }}'
    site_password: '{{ site_password }}'
    site_name: aci_site
    site_type: aci
    latitude: 50.887318
    longitude: 4.447084
    login_domain: "DefaultAuth"
    # security_domains: ["all"]
    inband_epg: In-Band-EPG
    state: present
  check_mode: true
  register: cm_add_site

- name: Verify cm_add_site
  assert:
    that:
    - cm_add_site is changed

# ADD SITE (Type - ACI)
- name: Create site (normal mode)
  cisco.nd.nd_site:
    <<: *site_present
    state: present
  register: nm_add_site

- name: Verify nm_add_site
  assert:
    that:
    - nm_add_site is changed

# ADD SITE again
- name: ADD site again
  cisco.nd.nd_site:
    <<: *site_present
  register: add_site_again

- name: Verify add_site_again
  assert:
    that:
    - add_site_again is not changed

# MODIFY SITE
- name: Modify site
  cisco.nd.nd_site:
    <<: *site_present
    # security_domains: ["all", "test_sec_domain"]
    latitude: 51.887318
    longitude: 5.447084
    state: present
  register: modify_site

- name: Verify modify_site
  assert:
    that:
    - modify_site is changed

# MODIFY SITE by re-registering the site
- name: Modify site
  cisco.nd.nd_site:
    <<: *site_present
    url: {{ apic_ip_address }}
    site_username: '{{ site_username }}'
    site_password: '{{ site_password }}'
    site_name: aci_site
    site_type: aci
    latitude: 50.887318
    longitude: 4.447084
    login_domain: "DefaultAuth"
    re_register: True
    state: present
  register: re_register_site

- name: Verify re_register_site
  assert:
    that:
    - re_register_site is changed

# ADD SITE (Type - Cloud)
- name: Create Cloud site 
  cisco.nd.nd_site:
    <<: *aci_info
    url: {{ apic_hostname }}
    site_username: '{{ site_username }}'
    site_password: '{{ site_password }}'
    site_name: cloud_test
    site_type: cloud_aci
    latitude: 50.887318
    longitude: 4.447084
    login_domain: "DefaultAuth"
    # security_domains: ["all"]
    inband_epg: In-Band-EPG
    state: present
  register: nm_add_cloud_site

- name: Verify nm_add_cloud_site
  assert:
    that:
    - nm_add_cloud_site is changed

# ADD SITE (Type - NDFC)
- name: Create NDFC site 
  cisco.nd.nd_site:
    <<: *aci_info
    url: {{ apic_hostname }}
    site_username: '{{ site_username }}'
    site_password: '{{ site_password }}'
    site_name: fabric-standalone
    site_type: ndfc
    login_domain: "DefaultAuth"
    # security_domains: ["all"]
    state: present
  register: nm_add_ndfc_site

- name: Verify nm_add_ndfc_site
  assert:
    that:
    - nm_add_ndfc_site is changed

# ADD SITE (Type - DCNM)
- name: Create DCNM site 
  cisco.nd.nd_site:
    <<: *aci_info
    url: {{ apic_hostname }}
    site_username: '{{ site_username }}'
    site_password: '{{ site_password }}'
    site_name: edge
    site_type: dcnm
    login_domain: "DefaultAuth"
    # security_domains: ["all"]
    state: present
  register: nm_add_dcnm_site

- name: Verify nm_add_dcnm_site
  assert:
    that:
    - nm_add_dcnm_site is changed