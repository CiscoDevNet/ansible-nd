# Test code for the ND modules
# Copyright: (c) 2023, Shreyas Srish (@shrsr) <ssrish@cisco.com>

# GNU General Public License v3.0+ (see LICENSE or https://www.gnu.org/licenses/gpl-3.0.txt)

- name: Install ND in check mode
  cisco.nd.nd_setup:
    output_level: debug
    cluster_name: cluster-one
    ntp_server: 173.36.212.205
    dns_server: 208.67.222.222
    dns_search_domain: cisco.com
    app_network: 172.17.0.1/16
    service_network: 100.80.0.0/16
    ntp_config:
      servers:
        - ntp_host: 173.36.212.205
          ntp_key_id: 1
          preferred: true
      keys:
        - ntp_key_id: 1
          ntp_key: "1"
          authentication_type: "AES128CMAC"
          trusted: true
    nodes:
      - hostname: Test
        serial_number: 0BCCC16E2AAC
        management_ip_address: 173.36.219.34
        username: rescue-user
        password: ins3965!
        management_network: 
          ipv4_address: 173.36.219.34/24
          ipv4_gateway: 173.36.219.1
        data_network:
          ipv4_address: 12.34.56.22/24
          ipv4_gateway: 12.34.56.1
  check_mode: true
  register: cluster_cm

- name: Install ND with an in-valid length of cluster name
  cisco.nd.nd_setup:
    output_level: debug
    cluster_name: clusteroneclusteroneclusteroneclusteroneclusteroneclusteroneclusterone
    ntp_server: 173.36.212.205
    dns_server: 208.67.222.222
    dns_search_domain: cisco.com
    app_network: 172.17.0.1/16
    service_network: 100.80.0.0/16
    nodes:
      - hostname: Test
        serial_number: 0BCCC16E2AAC
        management_ip_address: 173.36.219.34
        username: rescue-user
        password: ins3965!
        management_network: 
          ipv4_address: 173.36.219.34/24
          ipv4_gateway: 173.36.219.1
        data_network:
          ipv4_address: 12.34.56.22/24
          ipv4_gateway: 12.34.56.1
  ignore_errors: true
  register: cluster_name_length_error

- name: Install ND with in-valid characters in cluster name
  cisco.nd.nd_setup:
    output_level: debug
    cluster_name: cluster_one
    ntp_server: 173.36.212.205
    dns_server: 208.67.222.222
    dns_search_domain: cisco.com
    app_network: 172.17.0.1/16
    service_network: 100.80.0.0/16
    nodes:
      - hostname: Test
        serial_number: 0BCCC16E2AAC
        management_ip_address: 173.36.219.34
        username: rescue-user
        password: ins3965!
        management_network: 
          ipv4_address: 173.36.219.34/24
          ipv4_gateway: 173.36.219.1
        data_network:
          ipv4_address: 12.34.56.22/24
          ipv4_gateway: 12.34.56.1
  ignore_errors: true
  register: cluster_name_invalid_chars

- name: Install ND with a hyphen in the beginning/end of the cluster name
  cisco.nd.nd_setup:
    output_level: debug
    cluster_name: clusterone-
    ntp_server: 173.36.212.205
    dns_server: 208.67.222.222
    dns_search_domain: cisco.com
    app_network: 172.17.0.1/16
    service_network: 100.80.0.0/16
    nodes:
      - hostname: Test
        serial_number: 0BCCC16E2AAC
        management_ip_address: 173.36.219.34
        username: rescue-user
        password: ins3965!
        management_network: 
          ipv4_address: 173.36.219.34/24
          ipv4_gateway: 173.36.219.1
        data_network:
          ipv4_address: 12.34.56.22/24
          ipv4_gateway: 12.34.56.1
  ignore_errors: true
  register: cluster_name_invalid_hyphen

- name: Install ND in normal mode
  cisco.nd.nd_setup:
    output_level: debug
    cluster_name: cluster-one
    dns_server: 208.67.222.222
    dns_search_domain: cisco.com
    app_network: 172.17.0.1/16
    service_network: 100.80.0.0/16
    ntp_config:
      servers:
        - ntp_host: 173.36.212.205
          ntp_key_id: 1
          preferred: true
      keys:
          - ntp_key_id: 1
            ntp_key: "1"
            authentication_type: "AES128CMAC"
            trusted: true
    nodes:
      - hostname: Test
        serial_number: 0BCCC16E2AAC
        management_ip_address: 173.36.219.34
        username: rescue-user
        password: ins3965!
        management_network: 
          ipv4_address: 173.36.219.34/24
          ipv4_gateway: 173.36.219.1
        data_network:
          ipv4_address: 12.34.56.22/24
          ipv4_gateway: 12.34.56.1
          vlan: 1
  register: cluster_nm

- name: Wait for 30 seconds to establish connection
  ansible.builtin.pause:
    seconds: 30

- name: Check installation status of ND
  cisco.nd.nd_setup:
    state: query
  register: installation_status
  until: (installation_status.current.state is defined) and (installation_status.current.state == "Completed")
  retries: 100
  delay: 18

- name: Verify all assertions
  assert:
    that:
      - cluster_name_length_error.msg == "A length of 1 to 63 characters is allowed."
      - cluster_name_invalid_chars.msg == "Valid characters include letters, digits and hyphen."
      - cluster_name_invalid_hyphen.msg == "The name cannot start or end with a hyphen."
      - cluster_cm.current.clusterConfig.appNetwork == "172.17.0.1/16"
      - cluster_cm.current.clusterConfig.nameServers.0 == "208.67.222.222"
      - cluster_cm.current.clusterConfig.ntpConfig.servers.0.host == "173.36.212.205"
      - cluster_cm.current.clusterConfig.ntpConfig.servers.0.keyID == 1
      - cluster_cm.current.clusterConfig.ntpConfig.servers.0.prefer == true
      - cluster_cm.current.clusterConfig.searchDomains.0 == "cisco.com"
      - cluster_cm.current.clusterConfig.serviceNetwork == "100.80.0.0/16"
      - cluster_cm.current.nodes.0.dataNetwork.gateway == "12.34.56.1"
      - cluster_cm.current.nodes.0.dataNetwork.ipSubnet == "12.34.56.22/24"
      - cluster_cm.current.nodes.0.managementNetwork.gateway == "173.36.219.1"
      - cluster_cm.current.nodes.0.managementNetwork.ipSubnet == "173.36.219.34/24"
      - cluster_cm.current.nodes.0.serialNumber == "0BCCC16E2AAC"
      - cluster_cm.current.nodes.0.hostName == "Test"
      - cluster_nm.current.clusterConfig.appNetwork == "172.17.0.1/16"
      - cluster_nm.current.clusterConfig.nameServers.0 == "208.67.222.222"
      - cluster_nm.current.clusterConfig.ntpConfig.servers.0.host == "173.36.212.205"
      - cluster_nm.current.clusterConfig.ntpConfig.servers.0.keyID == 1
      - cluster_nm.current.clusterConfig.ntpConfig.servers.0.prefer == true
      - cluster_nm.current.clusterConfig.searchDomains.0 == "cisco.com"
      - cluster_nm.current.clusterConfig.serviceNetwork == "100.80.0.0/16"
      - cluster_nm.current.nodes.0.dataNetwork.gateway == "12.34.56.1"
      - cluster_nm.current.nodes.0.dataNetwork.ipSubnet == "12.34.56.22/24"
      - cluster_nm.current.nodes.0.managementNetwork.gateway == "173.36.219.1"
      - cluster_nm.current.nodes.0.managementNetwork.ipSubnet == "173.36.219.34/24"
      - cluster_nm.current.nodes.0.serialNumber == "0BCCC16E2AAC"
      - cluster_nm.current.nodes.0.hostName == "Test"
      - installation_status.current.clusterConfig.appNetwork == "172.17.0.1/16"
      - installation_status.current.clusterConfig.nameServers.0 == "208.67.222.222"
      - installation_status.current.clusterConfig.ntpServers.0 == "173.36.212.205"
      - installation_status.current.clusterConfig.searchDomains.0 == "cisco.com"
      - installation_status.current.clusterConfig.serviceNetwork == "100.80.0.0/16"
      - installation_status.current.nodes.0.dataNetwork.gateway == "12.34.56.1"
      - installation_status.current.nodes.0.dataNetwork.ipSubnet == "12.34.56.22/24"
      - installation_status.current.nodes.0.managementNetwork.gateway == "173.36.219.1"
      - installation_status.current.nodes.0.managementNetwork.ipSubnet == "173.36.219.34/24"
      - installation_status.current.nodes.0.serialNumber == "0BCCC16E2AAC"
      - installation_status.current.nodes.0.hostName == "Test"
      - installation_status.current.state == "Completed"
